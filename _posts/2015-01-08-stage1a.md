---
title: Chat Demo - Stage 1a - The server and client
layout: post
categories: chat_app
tags: node.js javascript websockets socket.io npm
---

Now that the folder structure for the Chat app is set up, we can start writing the client and server.

# The Server

I'm using the [Express](expressjs.com) framework to handle the web stuff in node.

## The index.js controller

{% highlight javascript %}

    var PORT = 33001;

    var app = require('express')();
    var server = require('http').Server(app);
    var routes = require('./lib/routes');
    var serveStatic = require('serve-static');

    require('./lib/socket').initialise(server);
    app.set('view engine','jade');

    app.use(serveStatic('public'));

    app.get('/', routes.index);

    server.listen(process.env.PORT || PORT);

{% endhighlight  %}

There are some points of elaboration:

* The HTTP server is created with the line `require('http').Server`

`Server` is an alias to the createServer function and returns a new Server instance. The express app is set as the
request listener.

You have to create the server yourself and not just let Express do it for you implicitly, becuase you need the
Server instance to attach the websocket (see [below](#the_socketio_handler)).

* Static files

`app.use(serveStatic('public'));`

The serveStatic middleware will serve all files in the 'public' folder to the '/' route.
i.e. asking for /css/chat.js in the browser will serve up the file in public/css/chat.css
Usually, I'll use NginX to serve static files; this is fine for development

* Jade templates

`app.set('view engine','jade');`

The [Jade templating](jade-lang.com) language make writing HTML pages a lot cleaner and simpler.

<id="socket">

## The socket.io handler

The code to handle websocket communication is really straightforward and illustrates the beauty of socket.io

{% highlight javascript %}

    var io = require('socket.io');
    exports.initialise = function(server) {
        var io = require('socket.io')(server);
        io.on('connection', function(socket) {
            console.log('Socket.io connection established.' );
            socket.emit('serverMessage','Welcome to the #ChatRoom');
            socket.on('userMessage', function(payload) {
                socket.broadcast.emit('userMessage', payload);
                socket.emit('myMessage', payload.msg);
            });
        });
    };

{% endhighlight  %}

This little piece of code already provides enough usability for a simple chat app. Behind the scenes you get the following
    out of the box:

* Fallback to XHR or polling if WebSockets aren't supported
* Automatic reconnection